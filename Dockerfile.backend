# Dockerfile –¥–ª—è backend (FastAPI)
FROM python:3.11-slim

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    tesseract-ocr \
    tesseract-ocr-rus \
    wget \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º requirements.txt
COPY backend/requirements.txt .

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ —Ä–µ—Ç—Ä–∞—è–º–∏
RUN pip install --no-cache-dir --timeout=300 --retries=3 -r requirements.txt

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
RUN pip install --no-cache-dir --timeout=300 --retries=3 \
    wheel \
    setuptools \
    pip-tools

# Ollama –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ backend
COPY backend/ .

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –±–ª–∞–Ω–∫
COPY frontend/public/blank.pdf ./blank.pdf

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
RUN mkdir -p uploaded_files generated_docs data

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PYTHONPATH
ENV PYTHONPATH=/app

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 8000

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
RUN echo '#!/bin/bash\n\
echo "üöÄ –ó–∞–ø—É—Å–∫ –í–µ—Ä–µ—Å-–¢–∞—Ä–∏—Ñ Backend"\n\
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."\n\
python update_db_schema.py\n\
echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."\n\
python init_db.py\n\
echo "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."\n\
uvicorn main:app --host 0.0.0.0 --port 8000\n\
' > /app/start.sh && chmod +x /app/start.sh

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["/app/start.sh"]
