# Dockerfile –¥–ª—è backend (FastAPI)
FROM python:3.11-slim

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    tesseract-ocr \
    tesseract-ocr-rus \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    wget \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º requirements.txt
COPY backend/requirements.txt .

# –û–±–Ω–æ–≤–ª—è–µ–º pip
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ —Ä–µ—Ç—Ä–∞—è–º–∏
RUN pip install --no-cache-dir --timeout=600 --retries=5 -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ backend
COPY backend/ .

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –±–ª–∞–Ω–∫ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
RUN mkdir -p /app/static
COPY frontend/public/blank.pdf ./static/blank.pdf 2>/dev/null || echo "blank.pdf not found, skipping"

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
RUN mkdir -p uploaded_files generated_docs data models_cache

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PORT=8000

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 8000

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
RUN echo '#!/bin/bash\n\
set -e\n\
echo "üöÄ –ó–∞–ø—É—Å–∫ –í–µ—Ä–µ—Å-–¢–∞—Ä–∏—Ñ Backend"\n\
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."\n\
python update_db_schema.py || echo "Schema update skipped"\n\
echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."\n\
python init_db.py || echo "DB init skipped"\n\
echo "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${PORT:-8000}..."\n\
exec uvicorn main:app --host 0.0.0.0 --port ${PORT:-8000}\n\
' > /app/start.sh && chmod +x /app/start.sh

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:${PORT:-8000}/health || exit 1

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["/app/start.sh"]
